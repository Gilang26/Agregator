<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Soneium DEX — Swap (v3.8.1 Manual Pair)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
:root{--g1:#22c55e;--g2:#16a34a;--bg1:#f6fff7;--bg2:#e9fbee;--card:#fff;--line:#e6f7ec;--text:#0e2b22;--mut:#6b7f77}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:Poppins,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));
color:var(--text);display:flex;align-items:center;justify-content:center}
.wrap{width:min(430px,94vw)}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.brand{display:flex;gap:10px;align-items:center}
.badge{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 180deg,var(--g1),var(--g2))}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 16px 36px rgba(16,185,129,.14)}
.box{background:#f8fff9;border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px}
.row{display:flex;gap:10px;align-items:center}
.sel{flex:0 0 150px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;font-weight:700}
.input-wrap{flex:1;display:flex;align-items:center;justify-content:flex-end;padding:0 4px}
.inp{width:100%;max-width:180px;text-align:right;font-size:22px;font-weight:700;border:0;background:transparent;outline:none}
.meta{display:flex;justify-content:space-between;font-size:12px;color:var(--mut);margin-top:6px}
.center{display:grid;place-items:center;color:var(--mut);margin:8px 0;font-weight:700}
.cta{width:100%;margin-top:12px;padding:14px;border:0;border-radius:12px;color:#fff;font-weight:800;background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer}
.cta:disabled{opacity:.6;cursor:not-allowed}
.footer{text-align:center;font-size:12px;color:var(--mut);margin-top:10px}
.note{font-size:12px;color:var(--mut);text-align:center;margin-top:6px}
.warn{color:#ef4444;font-size:12px;text-align:center;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="brand"><div class="badge"></div><div class="title">Soneium DEX</div></div>
    <button id="btnConnect" class="btn">Connect</button>
  </div>

  <div class="card">
    <div class="box">
      <div class="row">
        <select id="fromToken" class="sel">
          <option value="0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655">ASTR</option>
          <option value="0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391">USDC.e</option>
        </select>
        <div class="input-wrap">
          <input id="fromAmount" class="inp" placeholder="0.0" inputmode="decimal"/>
        </div>
      </div>
      <div class="meta"><span>Saldo</span><span id="balFrom">-</span></div>
    </div>

    <div class="center">⇅</div>

    <div class="box">
      <div class="row">
        <select id="toToken" class="sel">
          <option value="0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391">USDC.e</option>
          <option value="0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655">ASTR</option>
        </select>
        <div class="input-wrap"><div class="inp" id="toAmount">≈ -</div></div>
      </div>
      <div class="meta"><span>Saldo</span><span id="balTo">-</span></div>
    </div>

    <div class="meta" style="margin-top:8px"><span>Estimasi</span><span id="priceInfo">-</span></div>
    <div class="note">Estimator memakai <b>LP reserves</b> langsung (ASTR/USDC.e)</div>
    <div class="warn" id="warnRouter"></div>

    <button id="btnSwap" class="cta" disabled>Swap</button>
    <div class="footer">by thdx</div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const RPC="https://rpc.minato.soneium.org";
const CHAIN_ID=1946, CHAIN_HEX="0x79A";

/* Router tempat eksekusi swap.
   NOTE: jika ini sebenarnya LP (bukan router), swap akan gagal.
   Ganti ke router UniswapV2 kompatibel ketika kamu punya alamatnya. */
const ROUTER = "0x5E0b9C785e9599D6800601574E578E6Caa663d91";

/* LP ASTR/USDC.e untuk estimasi manual */
const PAIR  = "0x5E0b9C785e9599D6800601574E578E6Caa663d91";
const ASTR  = "0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655";
const USDCe = "0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391";

const TOKENS = {
  [ASTR.toLowerCase()]:  { symbol:"ASTR",  decimals:18 },
  [USDCe.toLowerCase()]: { symbol:"USDC.e",decimals:6  },
};

/* ===== ABIs ===== */
const ERC20_ABI=[
 "function balanceOf(address) view returns(uint256)",
 "function allowance(address,address) view returns(uint256)",
 "function approve(address,uint256) returns(bool)",
 "function decimals() view returns(uint8)"
];
const ROUTER_ABI=[
 "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline)"
];
const PAIR_ABI=[
 "function token0() view returns(address)",
 "function token1() view returns(address)",
 "function getReserves() view returns(uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
];

/* ===== STATE ===== */
const $=id=>document.getElementById(id);
let provider = new ethers.providers.JsonRpcProvider(RPC);
let signer, me;

/* ===== HELPERS ===== */
const key = a => a.toLowerCase();
const info = a => TOKENS[key(a)];
const fmt = (bn,dec)=>{ try{ return Number(ethers.utils.formatUnits(bn,dec)).toLocaleString(undefined,{maximumFractionDigits:6}); } catch{ return "-"; } };
const parse = (v,dec)=> ethers.utils.parseUnits(String(v).replace(",","."), dec);
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

/* ===== UI BIND ===== */
$("btnConnect").onclick = connect;
$("fromToken").onchange = onTokenChange;
$("toToken").onchange   = onTokenChange;
$("fromAmount").oninput = debounce(estimateManual, 200);
$("btnSwap").onclick    = doSwap;

/* ===== CONNECT ===== */
async function connect(){
  try{
    if(!window.ethereum) throw new Error("Install MetaMask");
    const web3 = new ethers.providers.Web3Provider(window.ethereum,"any");
    await web3.send("eth_requestAccounts",[]);
    signer = web3.getSigner(); me = await signer.getAddress();
    $("btnConnect").textContent = me.slice(0,6)+"…"+me.slice(-4);

    const net = await web3.getNetwork();
    if(Number(net.chainId)!==CHAIN_ID){
      try{ await web3.provider.request({method:"wallet_switchEthereumChain",params:[{chainId:CHAIN_HEX}]}); }
      catch(e){
        if(e.code===4902){
          await web3.provider.request({method:"wallet_addEthereumChain",params:[{chainId:CHAIN_HEX,chainName:"Soneium Minato",rpcUrls:[RPC],nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18}}]});
        } else { throw e; }
      }
    }
    provider = web3; // gunakan provider yang sama untuk read
    $("btnSwap").disabled = false;
    await refreshBalances();
    await estimateManual();
    // peringatan router jika sama dengan LP (kemungkinan besar bukan router)
    if (ROUTER.toLowerCase() === PAIR.toLowerCase()) {
      $("warnRouter").textContent = "⚠️ Alamat ROUTER sama dengan LP — jika swap gagal, ganti ROUTER ke kontrak router yang kompatibel.";
    }
  }catch(e){ alert("Connect error: "+(e.message||e)); }
}

/* ===== BALANCES ===== */
async function refreshBalances(){
  try{
    if(!me) return;
    const a=$("fromToken").value, b=$("toToken").value;
    const cA=new ethers.Contract(a, ERC20_ABI, provider);
    const cB=new ethers.Contract(b, ERC20_ABI, provider);
    const [ba,bb] = await Promise.all([cA.balanceOf(me), cB.balanceOf(me)]);
    $("balFrom").textContent = fmt(ba, info(a).decimals) + " " + info(a).symbol;
    $("balTo").textContent   = fmt(bb, info(b).decimals) + " " + info(b).symbol;
  }catch{ $("balFrom").textContent="-"; $("balTo").textContent="-"; }
}

/* ===== MANUAL QUOTE (pakai reserves LP) ===== */
async function estimateManual(){
  try{
    const tIn = $("fromToken").value;
    const tOut= $("toToken").value;
    const val = $("fromAmount").value.trim();
    if(!val || Number(val)<=0 || tIn===tOut){
      $("toAmount").textContent="≈ -"; $("priceInfo").textContent="-"; return;
    }

    // Hanya dukung ASTR <-> USDC.e via LP manual
    const set = new Set([key(tIn), key(tOut)]);
    const astrKey = key(ASTR), usdceKey = key(USDCe);
    if(!(set.has(astrKey) && set.has(usdceKey))){
      $("toAmount").textContent="≈ -";
      $("priceInfo").textContent="Pair belum diset untuk estimasi manual";
      return;
    }

    const pair = new ethers.Contract(PAIR, PAIR_ABI, provider);
    const [token0, token1] = await Promise.all([pair.token0(), pair.token1()]);
    const { reserve0, reserve1 } = await pair.getReserves();

    // Map reserve sesuai arah swap
    let reserveIn, reserveOut, decIn, decOut, symOut;
    const amountIn = parse(val, info(tIn).decimals);

    if (key(tIn) === key(token0)) {
      reserveIn  = reserve0;
      reserveOut = reserve1;
    } else if (key(tIn) === key(token1)) {
      reserveIn  = reserve1;
      reserveOut = reserve0;
    } else {
      // kalau urutan token0/token1 berbeda dengan daftar, bandingkan dengan ASTR/USDC.e
      if (key(token0) === astrKey && key(token1) === usdceKey) {
        // ok, map ulang berdasar input
        if (key(tIn) === astrKey) { reserveIn=reserve0; reserveOut=reserve1; }
        else { reserveIn=reserve1; reserveOut=reserve0; }
      } else if (key(token0) === usdceKey && key(token1) === astrKey) {
        if (key(tIn) === usdceKey) { reserveIn=reserve0; reserveOut=reserve1; }
        else { reserveIn=reserve1; reserveOut=reserve0; }
      } else {
        $("toAmount").textContent="≈ -";
        $("priceInfo").textContent="LP tidak cocok untuk ASTR/USDC.e";
        return;
      }
    }

    decIn  = info(tIn).decimals;
    decOut = info(tOut).decimals;
    symOut = info(tOut).symbol;

    // Formula Uniswap v2 dengan fee 0.3% (997/1000)
    const amountInWithFee = amountIn.mul(997).div(1000);
    const numerator   = amountInWithFee.mul(reserveOut);
    const denominator = reserveIn.add(amountInWithFee);
    const amountOut   = numerator.div(denominator);

    $("toAmount").textContent = "≈ " + fmt(amountOut, decOut) + " " + symOut;
    const per = Number(ethers.utils.formatUnits(amountOut, decOut)) / Number(val);
    $("priceInfo").textContent = `1 ${info(tIn).symbol} ≈ ${isFinite(per)?per.toFixed(6):"-"} ${symOut}`;
  }catch(e){
    $("toAmount").textContent="≈ -";
    $("priceInfo").textContent="Estimasi gagal";
  }
}

/* ===== TOKEN CHANGE ===== */
async function onTokenChange(){
  if($("fromToken").value === $("toToken").value){
    $("toToken").value = ($("fromToken").value.toLowerCase() === ASTR.toLowerCase()) ? USDCe : ASTR;
  }
  await refreshBalances();
  await estimateManual();
}

/* ===== APPROVE ===== */
async function ensureApprove(token, spender, amt){
  const c=new ethers.Contract(token, ERC20_ABI, signer);
  const al=await c.allowance(me, spender);
  if(al.gte(amt)) return;
  const tx=await c.approve(spender, amt);
  await tx.wait();
}

/* ===== SWAP (via ROUTER) ===== */
async function doSwap(){
  try{
    if(!signer) return alert("Connect wallet dulu");
    const tIn = $("fromToken").value;
    const tOut= $("toToken").value;
    const val = $("fromAmount").value.trim();
    if(!val || Number(val)<=0) return alert("Masukkan jumlah valid");

    const amountIn = parse(val, info(tIn).decimals);

    // Re-cek estimasi manual untuk outMin
    const pair = new ethers.Contract(PAIR, PAIR_ABI, provider);
    const [token0, token1] = await Promise.all([pair.token0(), pair.token1()]);
    const { reserve0, reserve1 } = await pair.getReserves();
    let reserveIn, reserveOut, decOut;

    if (key(tIn)===key(token0)) { reserveIn=reserve0; reserveOut=reserve1; }
    else if (key(tIn)===key(token1)) { reserveIn=reserve1; reserveOut=reserve0; }
    else return alert("LP tidak cocok");

    decOut = info(tOut).decimals;

    const amountInWithFee = amountIn.mul(997).div(1000);
    const numerator   = amountInWithFee.mul(reserveOut);
    const denominator = reserveIn.add(amountInWithFee);
    const amountOut   = numerator.div(denominator);
    const outMin      = amountOut.mul(95).div(100); // 5% slippage

    // Approve & swap
    await ensureApprove(tIn, ROUTER, amountIn);

    const r = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
    const path = [tIn, tOut];
    const deadline = Math.floor(Date.now()/1000)+900;

    const tx = await r.swapExactTokensForTokens(amountIn, outMin, path, me, deadline, { gasLimit: 900000 });
    alert("Tx sent: "+tx.hash);
    await tx.wait();
    alert("Swap confirmed!");
    await refreshBalances(); await estimateManual();
  }catch(e){
    alert("Swap error: "+(e.reason||e.data?.message||e.message));
  }
}

/* ===== DEFAULT ===== */
(function init(){
  $("fromToken").value = ASTR;
  $("toToken").value   = USDCe;
})();
</script>
</body>
</html>
