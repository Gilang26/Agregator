<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Swap ‚Ä¢ Soneium Testnet DEX</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
:root {
  --bg: #f9fafb;
  --card: #ffffff;
  --primary: #22c55e;
  --text: #111827;
  --muted: #6b7280;
  --border: #e5e7eb;
}
body {
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 24px;
  width: min(400px, 90vw);
  box-shadow: 0 10px 30px rgba(0,0,0,.05);
}
h1 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 20px;
}
.token-select {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f3f4f6;
  border-radius: 12px;
  padding: 10px;
}
select, input {
  border: none;
  background: transparent;
  font-size: 16px;
  font-weight: 500;
  outline: none;
  color: var(--text);
  width: 100%;
}
.amount-box {
  margin-top: 8px;
  background: #f9fafb;
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 12px;
}
button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(90deg,#22c55e,#16a34a);
  color: #fff;
  font-weight: 600;
  font-size: 16px;
  margin-top: 16px;
  cursor: pointer;
  transition: opacity .2s;
}
button:hover { opacity: .9; }
small { color: var(--muted); display: block; text-align: center; margin-top: 10px; }
pre {
  background: #f3f4f6;
  color: #1f2937;
  font-size: 13px;
  border-radius: 8px;
  padding: 10px;
  margin-top: 12px;
  max-height: 180px;
  overflow: auto;
}
</style>
</head>
<body>
<div class="card">
  <h1>Swap</h1>
  <div class="token-select">
    <select id="tokenFrom">
      <option value="0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391">USDC.e</option>
      <option value="0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655">ASTR</option>
      <option value="0x4200000000000000000000000000000000000006">WETH</option>
    </select>
    <span>‚Üí</span>
    <select id="tokenTo">
      <option value="0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655">ASTR</option>
      <option value="0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391">USDC.e</option>
      <option value="0x4200000000000000000000000000000000000006">WETH</option>
    </select>
  </div>

  <div class="amount-box">
    <input id="amount" type="number" placeholder="0.0" />
    <small id="balance">Saldo: -</small>
  </div>

  <button id="connect">üîå Connect Wallet</button>
  <button id="swap" disabled>üöÄ Swap Now</button>
  <pre id="log">log siap...</pre>
  <small>by thdx</small>
</div>

<script>
const $ = id => document.getElementById(id);
const log = m => { $("log").textContent += "\\n" + m; $("log").scrollTop = $("log").scrollHeight; console.log(m); };

const TOKENS = {
  "0xE9A198d38483aD727ABC8b0B1e16B2d338CF0391": {symbol:"USDC.e", decimals:6},
  "0x26e6f7c7047252DdE3dcBF26AA492e6a264Db655": {symbol:"ASTR", decimals:18},
  "0x4200000000000000000000000000000000000006": {symbol:"WETH", decimals:18}
};

const ROUTER_ADDRESS = "0x5E0b9C785e9599D6800601574E578E6Caa663d91"; // contoh router aktif
const ROUTER_ABI = [
  "function getAmountsOut(uint amountIn, address[] calldata path) view returns (uint[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) returns (uint[] memory amounts)"
];
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function approve(address,uint256) returns (bool)"
];

let provider, signer, me;

async function connect() {
  if (!window.ethereum) return alert("Install MetaMask dulu.");
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  me = await signer.getAddress();
  const net = await provider.getNetwork();
  log(`‚úÖ Connected: ${me}\\nChain: ${net.chainId}`);
  $("connect").disabled = true;
  $("swap").disabled = false;
  updateBalance();
}

async function updateBalance() {
  const token = $("tokenFrom").value;
  const erc = new ethers.Contract(token, ERC20_ABI, provider);
  const bal = await erc.balanceOf(me);
  const dec = TOKENS[token].decimals;
  const human = Number(ethers.utils.formatUnits(bal, dec)).toFixed(4);
  $("balance").textContent = `Saldo: ${human} ${TOKENS[token].symbol}`;
}

async function swapNow() {
  try {
    const tokenIn = $("tokenFrom").value;
    const tokenOut = $("tokenTo").value;
    const amount = $("amount").value.trim();
    if (!amount) return alert("Masukkan jumlah token.");
    const decIn = TOKENS[tokenIn].decimals;
    const amt = ethers.utils.parseUnits(amount, decIn);
    const router = new ethers.Contract(ROUTER_ADDRESS, ROUTER_ABI, signer);

    const erc = new ethers.Contract(tokenIn, ERC20_ABI, signer);
    const txA = await erc.approve(ROUTER_ADDRESS, amt);
    log(`‚è≥ Approve TX: ${txA.hash}`);
    await txA.wait();

    const path = [tokenIn, tokenOut];
    const deadline = Math.floor(Date.now()/1000)+1200;
    const tx = await router.swapExactTokensForTokens(amt, 0, path, me, deadline);
    log(`üöÄ TX: ${tx.hash}`);
    await tx.wait();
    log("‚úÖ Swap sukses!");
    updateBalance();
  } catch(e) {
    log("‚ùå Error: " + (e.reason || e.message || e));
  }
}

$("connect").onclick = connect;
$("swap").onclick = swapNow;
$("tokenFrom").onchange = updateBalance;
</script>
</body>
</html>
