<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Soneium Router Probe + Swap Tester</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body{font-family:system-ui,Arial;padding:16px;background:#0b1220;color:#e6edf3}
.card{background:#121a2a;border:1px solid #22304a;border-radius:12px;padding:16px;max-width:860px;margin:0 auto}
h1{margin:0 0 12px;color:#7c5cff}
input,select,button,textarea{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #22304a;background:#0f1625;color:#fff}
button{cursor:pointer;font-weight:700}
.btn{background:linear-gradient(90deg,#22c55e,#16a34a);border:0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
pre{white-space:pre-wrap;background:#0f1625;border:1px solid #22304a;border-radius:10px;padding:10px;margin-top:12px;max-height:340px;overflow:auto;font-size:13px}
small{color:#9fb0d9}
.bad{color:#fca5a5}
.ok{color:#86efac}
</style>
</head>
<body>
<div class="card">
  <h1>üîé Soneium Router Probe + Swap Tester</h1>
  <button id="btnConnect" class="btn">üîå Connect Wallet</button>
  <div class="row">
    <div>
      <label>Network</label>
      <input id="net" readonly placeholder="Soneium Minato (testnet)"/>
    </div>
    <div>
      <label>Account</label>
      <input id="acct" readonly/>
    </div>
  </div>

  <label>Addresses to probe (router/factory/pair) ‚Ä¢ satu per baris</label>
  <textarea id="addrList" rows="6">0x5E0b9C785e9599D6800601574E578E6Caa663d91
0x1A70b67B52049558B56Aa1854d3C9C11f0aD8E62
0xC7376dE2897b3F0b67c45Ae240444a2D435cA3E0</textarea>
  <button id="btnProbe" class="btn">üß™ Probe All</button>

  <h3>üß∞ Swap Tester (via Router lama)</h3>
  <div class="row">
    <div>
      <label>Router</label>
      <input id="router" placeholder="0x... (UniswapV2Router02)"/>
    </div>
    <div>
      <label>Factory (opsional)</label>
      <input id="factory" placeholder="0x... (UniswapV2Factory)"/>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Token In</label>
      <input id="tokenIn" placeholder="0x..."/>
    </div>
    <div>
      <label>Token Out</label>
      <input id="tokenOut" placeholder="0x..."/>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Amount In (human)</label>
      <input id="amtIn" type="number" placeholder="ex: 1.0"/>
    </div>
    <div>
      <label>Decimals In</label>
      <input id="decIn" type="number" placeholder="6/18" value="18"/>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Slippage Min Out (opsional, kosongkan = 0)</label>
      <input id="minOut" type="number" placeholder="ex: 0 (no min)"/>
    </div>
    <div>
      <label>Decimals Out</label>
      <input id="decOut" type="number" placeholder="6/18" value="18"/>
    </div>
  </div>
  <button id="btnSwap" class="btn">üöÄ Approve + Swap via Router</button>

  <pre id="log">log siap...</pre>
  <small>Tips: Kalau UI DEX lama mati tapi kontraknya hidup, swap tetap bisa via router ini. Untuk path multi-hop, ubah script ke array path [tokenIn, mid, tokenOut].</small>
</div>

<script>
const $ = id => document.getElementById(id);
const log = m => { const el=$("log"); el.textContent += (el.textContent?"\n":"") + m; el.scrollTop = el.scrollHeight; console.log(m); };

let provider, signer, me;

const SONEIUM = {
  name: "Soneium Minato",
  id: 1946,          // ganti ke chainId testnet Minato jika berbeda
  hex: "0x79A",      // 1946 ‚Üí 0x79A
  rpc: "https://rpc.minato.soneium.org", // fallback RPC; ganti jika kamu punya yang lebih stabil
  explorer: "https://soneium-minato.blockscout.com"
};

// Minimal ABIs (UniswapV2-like)
const ROUTER_ABI = [
  "function factory() view returns (address)",
  "function WETH() view returns (address)",
  "function getAmountsOut(uint amountIn, address[] calldata path) view returns (uint[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) returns (uint[] memory amounts)"
];
const FACTORY_ABI = [
  "function getPair(address,address) view returns (address)"
];
const PAIR_ABI = [
  "function token0() view returns (address)",
  "function token1() view returns (address)",
  "function getReserves() view returns (uint112,uint112,uint32)"
];
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function name() view returns (string)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

// ‚Äî‚Äî‚Äî connect ‚Äî‚Äî‚Äî
async function ensureSoneium(){
  const net = await provider.getNetwork();
  if (Number(net.chainId) === SONEIUM.id) return;
  try{
    await provider.provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId: SONEIUM.hex }] });
  }catch(e){
    if(e.code===4902){
      await provider.provider.request({
        method:"wallet_addEthereumChain",
        params:[{ chainId:SONEIUM.hex, chainName:SONEIUM.name, rpcUrls:[SONEIUM.rpc], blockExplorerUrls:[SONEIUM.explorer], nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18} }]
      });
    } else throw e;
  }
}

async function connect(){
  if(!window.ethereum) return alert("Wallet tidak ditemukan");
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner(); me = await signer.getAddress();
  await ensureSoneium();
  const net = await provider.getNetwork();
  $("net").value  = `${SONEIUM.name} (${net.chainId})`;
  $("acct").value = me;
  log(`‚úÖ Connected: ${me}\nChain: ${net.chainId}`);
}
$("btnConnect").onclick = connect;

// ‚Äî‚Äî‚Äî probe ‚Äî‚Äî‚Äî
async function isContract(addr){
  const code = await provider.getCode(addr);
  return code && code !== "0x";
}

async function tryCall(c, fn, args=[]){
  try{ return await c[fn](...args); }catch{ return null; }
}

async function probeOne(addr){
  const a = ethers.utils.getAddress(addr);
  if(!(await isContract(a))) { log(`‚ùå ${a} bukan kontrak`); return; }
  // coba router
  const r = new ethers.Contract(a, ROUTER_ABI, provider);
  const r_factory = await tryCall(r,"factory");
  const r_weth    = await tryCall(r,"WETH");
  if(r_factory && r_weth){
    log(`üß≠ Router terdeteksi: ${a}\n  ‚Ä¢ factory=${r_factory}\n  ‚Ä¢ WETH=${r_weth}`);
    $("router").value  = $("router").value || a;
    $("factory").value = $("factory").value || r_factory;
    return;
  }
  // coba factory
  const f = new ethers.Contract(a, FACTORY_ABI, provider);
  const f_ok = await tryCall(f,"getPair",[ethers.constants.AddressZero, ethers.constants.AddressZero]);
  if(f_ok !== null){ // meski 0x0, call sukses tandanya ABI cocok
    log(`üè≠ Factory terdeteksi: ${a}`);
    if(!$("factory").value) $("factory").value = a;
    return;
  }
  // coba pair
  const p = new ethers.Contract(a, PAIR_ABI, provider);
  const t0 = await tryCall(p,"token0");
  const t1 = await tryCall(p,"token1");
  const rs = await tryCall(p,"getReserves");
  if(t0 && t1 && rs){
    log(`ü§ù Pair terdeteksi: ${a}\n  ‚Ä¢ token0=${t0}\n  ‚Ä¢ token1=${t1}\n  ‚Ä¢ reserves=(${rs[0].toString()}, ${rs[1].toString()})`);
    return;
  }
  log(`‚ùì Tidak teridentifikasi: ${a}`);
}

async function probeAll(){
  try{
    const lines = $("addrList").value.split(/\s+/).filter(Boolean);
    for(const line of lines){ await probeOne(line); }
    log("‚úÖ Probe selesai.");
  }catch(e){ log("‚ùå Probe error: "+(e.message||e)); }
}
$("btnProbe").onclick = probeAll;

// ‚Äî‚Äî‚Äî swap tester ‚Äî‚Äî‚Äî
async function ensureApprove(token, spender, amount){
  const c = new ethers.Contract(token, ERC20_ABI, signer);
  const al = await c.allowance(me, spender);
  if(al.gte(amount)) return;
  const tx = await c.approve(spender, amount);
  log(`üßæ Approve: ${tx.hash}`); await tx.wait(); log("‚úÖ Approve done");
}

$("btnSwap").onclick = async ()=>{
  try{
    if(!signer) return alert("Connect wallet dulu");
    const router  = ethers.utils.getAddress($("router").value.trim());
    const tokenIn = ethers.utils.getAddress($("tokenIn").value.trim());
    const tokenOut= ethers.utils.getAddress($("tokenOut").value.trim());
    const amtInH  = $("amtIn").value.trim();
    const decIn   = Number($("decIn").value.trim()||"18");
    const minOutH = $("minOut").value.trim();
    const decOut  = Number($("decOut").value.trim()||"18");
    if(!amtInH) return alert("Isi Amount In");
    const amountIn  = ethers.utils.parseUnits(amtInH, decIn);
    const amountMin = minOutH ? ethers.utils.parseUnits(minOutH, decOut) : ethers.constants.Zero;

    const r = new ethers.Contract(router, ROUTER_ABI, signer);
    const path = [tokenIn, tokenOut];
    // quote (optional)
    try{
      const out = await r.getAmountsOut(amountIn, path);
      log(`üìê Quote: ${ethers.utils.formatUnits(out[out.length-1], decOut)} (tokenOut)`);
    }catch{}

    await ensureApprove(tokenIn, router, amountIn);
    const deadline = Math.floor(Date.now()/1000)+1200;
    log(`üöÄ swapExactTokensForTokens on ${router} ...`);
    const tx = await r.swapExactTokensForTokens(amountIn, amountMin, path, me, deadline);
    log(`‚è≥ TX: ${tx.hash}`);
    await tx.wait();
    log("‚úÖ Swap sukses!");
  }catch(e){
    log("‚ùå Swap error: "+(e.reason||e.message||e));
  }
};
</script>
</body>
</html>
